<!doctype html>
<html>

<head>

  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Survey Form</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">

    <link rel="stylesheet" href="survey.css" />
  </head>

<body>
  <div class="container mt-5">
    <!--Status banner-->
    <div id="formBanner" class="alert text-center" hidden></div>
    <h2>Add a new character</h2>
    <form id="characterForm">
      <!-- Character Name -->
      <label>Character Name:</label>
      <input type="text" class="form-control" name="characterName" placeholder="Enter character name" required />

      <!-- Character Age -->
      <label class="mt-3">Character Age:</label>
      <input type="number" class="form-control" name="characterAge" placeholder="Enter character age" min="0"
        required />

      <!-- Character Gender -->
      <label class="mt-3">Gender:</label>
      <div>
        <div class="form-check">
          <input class="form-check-input" type="radio" name="gender" value="Male" id="genderMale" required />
          <label class="form-check-label" for="genderMale">Male</label>
        </div>
        <div class="form-check">
          <input class="form-check-input" type="radio" name="gender" value="Female" id="genderFemale" required />
          <label class="form-check-label" for="genderFemale">Female</label>
        </div>
        <div class="form-check">
          <input class="form-check-input" type="radio" name="gender" value="Non-Binary" id="genderNonBinary" required />
          <label class="form-check-label" for="genderNonBinary">Non-Binary</label>
        </div>
        <div class="form-check">
          <input class="form-check-input" type="radio" name="gender" value="Other" id="genderOther" required />
          <label class="form-check-label" for="genderOther">Other</label>
        </div>
      </div>

      <!-- Character Nationality -->
      <label class="mt-3">Character Nationality:</label>
      <select class="form-select" name="nationality" required>
        <option value="">Select Nationality</option>
        <option value="Spanish">Spanish</option>
        <option value="Russian">Russian</option>
        <option value="English">English</option>
        <option value="Slovacian">Slovacian</option>
        <option value="Hungarian">Hungarian</option>
        <option value="Roman">Roman</option>
        <option value="Persian">Persian</option>
        <option value="German">German</option>
        <option value="Greek">Greek</option>
        <option value="Turkish">Turkish</option>
        <option value="Egyptian">Egyptian</option>
        <option value="Indian">Indian</option>
        <option value="Bulgarian">Bulgarian</option>
        <option value="Croatian">Croatian</option>
        <option value="Bosnian">Bosnian</option>
        <option value="Georgian">Georgian</option>
        <option value="Ethiopian">Ethiopian</option>
        <option value="Byzantine">Byzantine</option>
        <option value="Scythian">Scythian</option>
        <option value="Celtic">Celtic</option>
        <option value="Assyrian">Assyrian</option>
      </select>

      <!-- Character Role -->
      <label class="mt-3">Role in the Story:</label>
      <select class="form-select" name="role" required>
        <option value="">Select Role</option>
        <option value="Protagonist">Protagonist</option>
        <option value="Major Antagonist">Major Antagonist</option>
        <option value="Minor Antagonist">Minor Antagonist</option>
        <option value="Major Character">Major Character</option>
        <option value="Minor Character">Minor Character</option>
      </select>

      <!-- Character Backstory -->
      <label class="mt-3">Character Backstory:</label>
      <textarea class="form-control" name="backstory" rows="4" placeholder="Enter character backstory"
        required></textarea>

      <!-- Character Arc -->
      <label class="mt-3">Character Arc:</label>
      <select class="form-select" name="arc" id="arc" required>
        <option value="">Select Arc</option>
        <!-- Options will be populated by JavaScript -->
      </select>

      <!-- # of Chapters -->
      <label class="mt-3"># of Chapters:</label>
      <input type="number" class="form-control" name="arcChapters" id="arcChapters"
        placeholder="Enter number of chapters" min="1" required />

      <!-- Chapter Summary -->
      <label class="mt-3">Chapter Summary:</label>
      <textarea class="form-control" name="chapterSummary" id="chapterSummary" rows="4"
        placeholder="Enter chapter summary" required></textarea>

      <!-- File Upload -->
      <label class="mt-3">Upload Character Image:</label>
      <input type="file" class="form-control" name="characterImage" accept="image/*" />

      <!-- Submit Button -->
      <button type="submit" class="btn btn-primary mt-4" id="submit">Submit</button>
    </form>
  </div>
  </div>

  <script>
    const isEmpty = (obj) => Object.keys(obj).length === 0;

    // Fetch arcs and populate the dropdown
    fetch("/unholy/", { method: 'GET' })
      .then((response) => {
        return new Promise((resolve) => response.json()
          .then((json) => resolve({
            status: response.status,
            json,
          }))
        );
      })
      .then(({ status, json }) => {
        if (200 === status) {
          const arcDropDown = document.getElementById('arc');
          const arcs = json.arcs; // âœ… properly extract arcs

          // âœ… Safely check arcs first!
          if (arcs && arcs.length > 0) {
            for (const arc of arcs) {
              let option = document.createElement("option");
              option.value = arc.arc_id;
              option.text = `${arc.arc_name} (${arc.arc_chapters} chapters)`;
              arcDropDown.add(option);
            }
          }
        }
      })
      .catch(error => {
        console.error('Error:', error);
      });
    document.getElementById('submit').addEventListener('click', (event) => {
      event.preventDefault(); // Prevent form submission

      const characterName = document.querySelector('input[name="characterName"]');
      const characterAge = document.querySelector('input[name="characterAge"]');
      const gender = document.querySelector('input[name="gender"]:checked');
      const nationality = document.querySelector('select[name="nationality"]');
      const role = document.querySelector('select[name="role"]');
      const backstory = document.querySelector('textarea[name="backstory"]');
      const arcDropdown = document.querySelector('select[name="arc"]');
      const arcChapters = document.querySelector('input[name="arcChapters"]');
      const chapterSummary = document.querySelector('textarea[name="chapterSummary"]');
      const characterImage = document.querySelector('input[name="characterImage"]');

      if (!characterName || !characterAge || !gender || !nationality || !role || !backstory || !arcDropdown || !arcChapters || !chapterSummary) {
        alert('Please fill out all required fields.');
        return;
      }

      const formData = new FormData();
      formData.append('characterName', characterName.value);
      formData.append('characterAge', characterAge.value);
      formData.append('gender', gender.value);
      formData.append('nationality', nationality.value);
      formData.append('role', role.value);
      formData.append('backstory', backstory.value);
      formData.append('arc', arcDropdown.options[arcDropdown.selectedIndex].text.split(' (')[0]);
      // ðŸ‘† Only use the Arc Name, cutting off " (5 chapters)"

      formData.append('arcChapters', arcChapters.value);
      formData.append('chapterSummary', chapterSummary.value);

      if (characterImage.files.length > 0) {
        formData.append('characterImage', characterImage.files[0]);
      }

      for (let pair of formData.entries()) {
        console.log(pair[0] + ': ' + pair[1]);
      }

      const banner = document.getElementById('formBanner'); // Declare at top

      fetch('/unholy', {
        method: 'POST',
        body: formData
      })
        .then(response => {
          return response.json().then(data => ({
            status: response.status,
            body: data
          }));
        })
        .then(({ status, body }) => {
          banner.hidden = false;
          banner.innerText = body.message || (status === 200 ? 'Character added successfully!' : 'Unexpected response.');

          if (status === 200) {
            console.log('200 OK: Character added successfully.');
            banner.className = 'alert alert-success text-center mt-3';
            setTimeout(() => window.location.href = 'index.html', 2000);
          } else {
            console.error('400/500 Error: Failed to add character.');
            banner.className = 'alert alert-danger text-center mt-3';
          }
        })
        .catch(error => {
          console.error('Network error during insert:', error);
          banner.hidden = false;
          banner.className = 'alert alert-danger text-center mt-3';
          banner.innerText = 'Network error. Please try again.';
        });
    });
  </script>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>

</html>