<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Edit Character</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="survey.css" />
</head>

<body>
  <div class="container mt-5">
    <!--Status banner-->
    <div id="formBanner" class="alert text-center" hidden></div>
    
    <h2>Edit Character</h2>
    <form id="editCharacterForm">
      <label>Character Name:</label>
      <input type="text" class="form-control" name="characterName" required />

      <label class="mt-3">Character Age:</label>
      <input type="number" class="form-control" name="characterAge" min="0" required />

      <label class="mt-3">Gender:</label>
      <div>
        <div class="form-check">
          <input class="form-check-input" type="radio" name="gender" value="Male" id="genderMale" required />
          <label class="form-check-label" for="genderMale">Male</label>
        </div>
        <div class="form-check">
          <input class="form-check-input" type="radio" name="gender" value="Female" id="genderFemale" required />
          <label class="form-check-label" for="genderFemale">Female</label>
        </div>
        <div class="form-check">
          <input class="form-check-input" type="radio" name="gender" value="Non-Binary" id="genderNonBinary" required />
          <label class="form-check-label" for="genderNonBinary">Non-Binary</label>
        </div>
        <div class="form-check">
          <input class="form-check-input" type="radio" name="gender" value="Other" id="genderOther" required />
          <label class="form-check-label" for="genderOther">Other</label>
        </div>
      </div>

      <label class="mt-3">Character Nationality:</label>
      <select class="form-select" name="nationality" required>
        <option value="">Select Nationality</option>
        <option value="Spanish">Spanish</option>
        <option value="Russian">Russian</option>
        <option value="English">English</option>
        <option value="Slovacian">Slovacian</option>
        <option value="Hungarian">Hungarian</option>
        <option value="Roman">Roman</option>
        <option value="Persian">Persian</option>
        <option value="German">German</option>
        <option value="Greek">Greek</option>
        <option value="Turkish">Turkish</option>
        <option value="Egyptian">Egyptian</option>
        <option value="Indian">Indian</option>
        <option value="Bulgarian">Bulgarian</option>
        <option value="Croatian">Croatian</option>
        <option value="Bosnian">Bosnian</option>
        <option value="Georgian">Georgian</option>
        <option value="Ethiopian">Ethiopian</option>
        <option value="Byzantine">Byzantine</option>
        <option value="Scythian">Scythian</option>
        <option value="Celtic">Celtic</option>
        <option value="Assyrian">Assyrian</option>
      </select>

      <label class="mt-3">Role in the Story:</label>
      <select class="form-select" name="role" required>
        <option value="">Select Role</option>
        <option value="Protagonist">Protagonist</option>
        <option value="Major Antagonist">Major Antagonist</option>
        <option value="Minor Antagonist">Minor Antagonist</option>
        <option value="Major Character">Major Character</option>
        <option value="Minor Character">Minor Character</option>
      </select>

      <label class="mt-3">Character Backstory:</label>
      <textarea class="form-control" name="backstory" rows="4" required></textarea>

      <label class="mt-3">Character Arc:</label>
      <select class="form-select" name="arc" id="arc" required>
        <option value="">Select Arc</option>
      </select>

      <label class="mt-3"># of Chapters:</label>
      <input type="number" class="form-control" name="arcChapters" id="arcChapters" min="1" required />

      <label class="mt-3">Chapter Summary:</label>
      <textarea class="form-control" name="chapterSummary" id="chapterSummary" rows="4" required></textarea>

      <label class="mt-3">Upload Character Image:</label>
      <input type="file" class="form-control" name="characterImage" accept="image/*" />

      <button type="submit" class="btn btn-primary mt-4" id="submit">Submit</button>
    </form>
  </div>

<script>
const urlParams = new URLSearchParams(window.location.search);

fetch("/unholy/", { method: 'GET' })
  .then(response => response.json())
  .then(json => {
    const arcDropDown = document.getElementById('arc');
    const arcs = json.arcs;
    if (arcs && arcs.length > 0) {
      for (const arc of arcs) {
        let option = document.createElement("option");
        option.value = arc.arc_id;
        option.text = `${arc.arc_name} (${arc.arc_chapters} chapters)`;
        arcDropDown.add(option);
      }
    }
  })
  .catch(error => console.error('Error loading arcs:', error));

document.getElementById('submit').addEventListener('click', (event) => {
  event.preventDefault();

  const characterName = document.querySelector('input[name="characterName"]').value;
  const characterAge = document.querySelector('input[name="characterAge"]').value;
  const gender = document.querySelector('input[name="gender"]:checked').value;
  const nationality = document.querySelector('select[name="nationality"]').value;
  const role = document.querySelector('select[name="role"]').value;
  const backstory = document.querySelector('textarea[name="backstory"]').value;
  const arcDropdown = document.querySelector('select[name="arc"]');
  const arcChapters = document.querySelector('input[name="arcChapters"]').value;
  const chapterSummary = document.querySelector('textarea[name="chapterSummary"]').value;
  const characterImage = document.querySelector('input[name="characterImage"]');

  const formData = new FormData();
  formData.append('characterName', characterName);
  formData.append('characterAge', characterAge);
  formData.append('gender', gender);
  formData.append('nationality', nationality);
  formData.append('role', role);
  formData.append('backstory', backstory);
  formData.append('arc', arcDropdown.options[arcDropdown.selectedIndex].text.split(' (')[0]);
  formData.append('arcChapters', arcChapters);
  formData.append('chapterSummary', chapterSummary);

  if (characterImage.files.length > 0) {
    formData.append('characterImage', characterImage.files[0]);
  }

  fetch('/unholy/' + urlParams.get('id') + '/', {
  method: 'PUT',
  body: formData
})
.then(response => {
  const banner = document.getElementById('formBanner');
  if (response.ok) {
    console.log('200 OK: Character updated successfully.');
    banner.className = 'alert alert-success text-center';
    banner.textContent = 'Character updated successfully!';
    banner.hidden = false;
    setTimeout(() => window.location.href = 'index.html', 1500);
  } else {
    console.error('400/500 Error: Something went wrong during update.');
    banner.className = 'alert alert-danger text-center';
    banner.textContent = 'Something went wrong. Please try again.';
    banner.hidden = false;
  }
})
.catch(error => {
  console.error('Network error during update:', error);
  const banner = document.getElementById('formBanner');
  banner.className = 'alert alert-danger text-center';
  banner.textContent = 'Network error. Please try again later.';
  banner.hidden = false;
});
});
</script>

</body>
</html>
